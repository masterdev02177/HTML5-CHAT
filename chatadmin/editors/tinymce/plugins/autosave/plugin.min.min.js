tinymce.PluginManager.add("autosave",function(A){function v(a,c){var d={s:1000,m:60000};return a=/^(\d+)([ms]?)$/.exec(""+(a||c)),(a[2]?d[a[2]]:1)*parseInt(a,10)}function h(){var a=parseInt(j.getItem(q+"autosave.time"),10)||0;return(new Date).getTime()-a>w.autosave_retention?(p(),!1):!0}function p(){j.removeItem(q+"autosave.draft"),j.removeItem(q+"autosave.time")}function y(){x&&A.isDirty()&&(j.setItem(q+"autosave.draft",A.getContent({format:"raw",no_events:!0})),j.setItem(q+"autosave.time",(new Date).getTime()),A.fire("StoreDraft"))}function b(){h()&&(A.setContent(j.getItem(q+"autosave.draft"),{format:"raw"}),p(),A.fire("RestoreDraft"))}function g(){x||(setInterval(function(){A.removed||y()},w.autosave_interval),x=!0)}function B(){var a=this;a.disabled(!h()),A.on("StoreDraft RestoreDraft",function(){a.disabled(!h())}),g()}function k(){A.undoManager.beforeChange(),b(),A.undoManager.add()}function z(){var a;return tinymce.each(tinymce.editors,function(c){c.plugins.autosave&&c.plugins.autosave.storeDraft(),!a&&c.isDirty()&&c.getParam("autosave_ask_before_unload",!0)&&(a=c.translate("You have unsaved changes are you sure you want to navigate away?"))}),a}var x,w=A.settings,j=tinymce.util.LocalStorage,q=A.id;w.autosave_interval=v(w.autosave_interval,"30s"),w.autosave_retention=v(w.autosave_retention,"20m"),A.addButton("restoredraft",{title:"Restore last draft",onclick:k,onPostRender:B}),A.addMenuItem("restoredraft",{text:"Restore last draft",onclick:k,onPostRender:B,context:"file"}),this.storeDraft=y,window.onbeforeunload=z});