tinymce.PluginManager.add("fullpage",function(p){function w(){var a=j();p.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(c){h(tinymce.extend(a,c.data))}})}function j(){function e(o,n){var a=o.attr(n);return a||""}var d,i,c=k(),g={};return g.fontface=p.getParam("fullpage_default_fontface",""),g.fontsize=p.getParam("fullpage_default_fontsize",""),d=c.firstChild,7==d.type&&(g.xml_pi=!0,i=/encoding="([^"]+)"/.exec(d.value),i&&(g.docencoding=i[1])),d=c.getAll("#doctype")[0],d&&(g.doctype="<!DOCTYPE"+d.value+">"),d=c.getAll("title")[0],d&&d.firstChild&&(g.title=d.firstChild.value),u(c.getAll("meta"),function(r){var o,a=r.attr("name"),s=r.attr("http-equiv");a?g[a.toLowerCase()]=r.attr("content"):"Content-Type"==s&&(o=/charset\s*=\s*(.*)\s*/gi.exec(r.attr("content")),o&&(g.docencoding=o[1]))}),d=c.getAll("html")[0],d&&(g.langcode=e(d,"lang")||e(d,"xml:lang")),d=c.getAll("link")[0],d&&"stylesheet"==d.attr("rel")&&(g.stylesheet=d.attr("href")),d=c.getAll("body")[0],d&&(g.langdir=e(d,"dir"),g.style=e(d,"style"),g.visited_color=e(d,"vlink"),g.link_color=e(d,"link"),g.active_color=e(d,"alink")),g}function h(A){function i(o,n,a){o.attr(n,a?a:void 0)}function e(a){d.firstChild?d.insert(a,d.firstChild):d.append(a)}var y,d,c,B,g,z=p.dom;y=k(),d=y.getAll("head")[0],d||(B=y.getAll("html")[0],d=new m("head",1),B.firstChild?B.insert(d,B.firstChild,!0):B.append(d)),B=y.firstChild,A.xml_pi?(g='version="1.0"',A.docencoding&&(g+=' encoding="'+A.docencoding+'"'),7!=B.type&&(B=new m("xml",7),y.insert(B,y.firstChild,!0)),B.value=g):B&&7==B.type&&B.remove(),B=y.getAll("#doctype")[0],A.doctype?(B||(B=new m("#doctype",10),A.xml_pi?y.insert(B,y.firstChild):e(B)),B.value=A.doctype.substring(9,A.doctype.length-1)):B&&B.remove(),A.docencoding&&(B=null,u(y.getAll("meta"),function(a){"Content-Type"==a.attr("http-equiv")&&(B=a)}),B||(B=new m("meta",1),B.attr("http-equiv","Content-Type"),B.shortEnded=!0,e(B)),B.attr("content","text/html; charset="+A.docencoding)),B=y.getAll("title")[0],A.title?B||(B=new m("title",1),B.append(new m("#text",3)).value=A.title,e(B)):B&&B.remove(),u("keywords,description,author,copyright,robots".split(","),function(t){var a,n,C=y.getAll("meta"),s=A[t];for(a=0;a<C.length;a++){if(n=C[a],n.attr("name")==t){return s?n.attr("content",s):n.remove(),void 0}}s&&(B=new m("meta",1),B.attr("name",t),B.attr("content",s),B.shortEnded=!0,e(B))}),B=y.getAll("link")[0],B&&"stylesheet"==B.attr("rel")?A.stylesheet?B.attr("href",A.stylesheet):B.remove():A.stylesheet&&(B=new m("link",1),B.attr({rel:"stylesheet",text:"text/css",href:A.stylesheet}),B.shortEnded=!0,e(B)),B=y.getAll("body")[0],B&&(i(B,"dir",A.langdir),i(B,"style",A.style),i(B,"vlink",A.visited_color),i(B,"link",A.link_color),i(B,"alink",A.active_color),z.setAttribs(p.getBody(),{style:A.style,dir:A.dir,vLink:A.visited_color,link:A.link_color,aLink:A.active_color})),B=y.getAll("html")[0],B&&(i(B,"lang",A.langcode),i(B,"xml:lang",A.langcode)),d.firstChild||d.remove(),c=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(y),q=c.substring(0,c.indexOf("</body>"))}function k(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(q)}function v(A){function i(a){return a.replace(/<\/?[A-Z]+/g,function(g){return g.toLowerCase()})}var d,y,c,o,e=A.content,z="",s=p.dom;A.selection||"raw"==A.format&&q||A.source_view&&p.getParam("fullpage_hide_in_source_view")||(e=e.replace(/<(\/?)BODY/gi,"<$1body"),d=e.indexOf("<body"),-1!=d?(d=e.indexOf(">",d),q=i(e.substring(0,d+1)),y=e.indexOf("</body",d),-1==y&&(y=e.length),A.content=e.substring(d+1,y),x=i(e.substring(y))):(q=f(),x="\n</body>\n</html>"),c=k(),u(c.getAll("style"),function(a){a.firstChild&&(z+=a.firstChild.value)}),o=c.getAll("body")[0],o&&s.setAttribs(p.getBody(),{style:o.attr("style")||"",dir:o.attr("dir")||"",vLink:o.attr("vlink")||"",link:o.attr("link")||"",aLink:o.attr("alink")||""}),s.remove("fullpage_styles"),z&&(s.add(p.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},z),o=s.get("fullpage_styles"),o.styleSheet&&(o.styleSheet.cssText=z)))}function f(){var c,a="",d="";return p.getParam("fullpage_default_xml_pi")&&(a+='<?xml version="1.0" encoding="'+p.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),a+=p.getParam("fullpage_default_doctype","<!DOCTYPE html>"),a+="\n<html>\n<head>\n",(c=p.getParam("fullpage_default_title"))&&(a+="<title>"+c+"</title>\n"),(c=p.getParam("fullpage_default_encoding"))&&(a+='<meta http-equiv="Content-Type" content="text/html; charset='+c+'" />\n'),(c=p.getParam("fullpage_default_font_family"))&&(d+="font-family: "+c+";"),(c=p.getParam("fullpage_default_font_size"))&&(d+="font-size: "+c+";"),(c=p.getParam("fullpage_default_text_color"))&&(d+="color: "+c+";"),a+="</head>\n<body"+(d?' style="'+d+'"':"")+">\n"}function b(a){a.selection||a.source_view&&p.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(q)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(x))}var q,x,u=tinymce.each,m=tinymce.html.Node;p.addCommand("mceFullPageProperties",w),p.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),p.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),p.on("BeforeSetContent",v),p.on("GetContent",b)});