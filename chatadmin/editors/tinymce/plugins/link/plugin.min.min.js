tinymce.PluginManager.add("link",function(b){function a(d){return function(){var e=b.settings.link_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(f){d(tinymce.util.JSON.parse(f))}}):d(e)}}function c(D){function k(){var d=[{text:"None",value:""}];return tinymce.each(D,function(f){d.push({text:f.text||f.title,value:f.value||f.url,menu:f.menu})}),d}function v(d){var f=[{text:"None",value:""}];return tinymce.each(b.settings.rel_list,function(g){f.push({text:g.text||g.title,value:g.value,selected:d===g.value})}),f}function B(d){var f=[{text:"None",value:""}];return b.settings.target_list||f.push({text:"New window",value:"_blank"}),tinymce.each(b.settings.target_list,function(g){f.push({text:g.text||g.title,value:g.value,selected:d===g.value})}),f}function e(){E||0!==y.text.length||this.parent().parent().find("#text")[0].value(this.value())}var j,q,E,A,C,z,p,y={},x=b.selection,w=b.dom;b.focus(),j=x.getNode(),q=w.getParent(j,"a[href]"),q&&x.select(q),y.text=E=x.getContent({format:"text"}),y.href=q?w.getAttrib(q,"href"):"",y.target=q?w.getAttrib(q,"target"):"",y.rel=q?w.getAttrib(q,"rel"):"","IMG"==j.nodeName&&(y.text=E=" "),D&&(C={type:"listbox",label:"Link list",values:k(),onselect:function(f){var d=A.find("#text");(!d.value()||f.lastControl&&d.value()==f.lastControl.text())&&d.value(f.control.text()),A.find("#href").value(f.control.value())}}),b.settings.target_list!==!1&&(p={name:"target",type:"listbox",label:"Target",values:B(y.target)}),b.settings.rel_list&&(z={name:"rel",type:"listbox",label:"Rel",values:v(y.rel)}),A=b.windowManager.open({title:"Insert link",data:y,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:e,onkeyup:e},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){y.text=this.value()}},C,z,p],onSubmit:function(g){function l(i,m){window.setTimeout(function(){b.windowManager.confirm(i,m)},0)}function f(){d.text!=E?q?(b.focus(),q.innerHTML=d.text,w.setAttribs(q,{href:h,target:d.target?d.target:null,rel:d.rel?d.rel:null}),x.select(q)):b.insertContent(w.createHTML("a",{href:h,target:d.target?d.target:null,rel:d.rel?d.rel:null},d.text)):b.execCommand("mceInsertLink",!1,{href:h,target:d.target,rel:d.rel?d.rel:null})}var d=g.data,h=d.href;return h?h.indexOf("@")>0&&-1==h.indexOf("//")&&-1==h.indexOf("mailto:")?(l("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(i){i&&(h="mailto:"+h),f()}),void 0):/^\s*www\./i.test(h)?(l("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(i){i&&(h="http://"+h),f()}),void 0):(f(),void 0):(b.execCommand("unlink"),void 0)}})}b.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:a(c),stateSelector:"a[href]"}),b.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),b.addShortcut("Ctrl+K","",c),this.showDialog=c,b.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:a(c),stateSelector:"a[href]",context:"insert",prependToContext:!0})});