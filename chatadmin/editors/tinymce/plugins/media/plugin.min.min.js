tinymce.PluginManager.add("media",function(j,p){function f(a){return -1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":""}function h(){function e(s){var i,c,n,u;i=r.find("#width")[0],c=r.find("#height")[0],n=i.value(),u=c.value(),r.find("#constrain")[0].checked()&&a&&l&&n&&u&&(s.control==i?(u=Math.round(n/a*u),c.value(u)):(n=Math.round(u/l*n),i.value(n))),a=n,l=u}var r,a,l,o;o=g(j.selection.getNode()),a=o.width,l=o.height,r=j.windowManager.open({title:"Insert/edit video",data:o,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){this.fromJSON(d(this.next().find("#embed").value()))},items:[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source"},{name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"},{name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:e},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:e},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}]},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(b(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:"},{type:"textbox",flex:1,name:"embed",value:m(),multiline:!0,label:"Source"}]}],onSubmit:function(){j.insertContent(b(this.toJSON()))}})}function m(){var a=j.selection.getNode();return a.getAttribute("data-mce-object")?j.selection.getContent():void 0}function b(e){var c="";return e.source1||(tinymce.extend(e,d(e.embed)),e.source1)?(e.source1=j.convertURL(e.source1,"source"),e.source2=j.convertURL(e.source2,"source"),e.source1mime=f(e.source1),e.source2mime=f(e.source2),e.poster=j.convertURL(e.poster,"poster"),e.flashPlayerUrl=j.convertURL(p+"/moxieplayer.swf","movie"),e.embed?c=q(e.embed,e,!0):(tinymce.each(k,function(o){var l,r,i;if(l=o.regex.exec(e.source1)){for(i=o.url,r=0;l[r];r++){i=i.replace("$"+r,function(){return l[r]})}e.source1=i,e.type=o.type,e.width=o.w,e.height=o.h}}),e.width=e.width||300,e.height=e.height||150,tinymce.each(e,function(a,i){e[i]=j.dom.encode(a)}),"iframe"==e.type?c+='<iframe src="../../../../../admin/editors/tinymce/plugins/media/'+e.source1+'" width="'+e.width+'" height="'+e.height+'"></iframe>':-1!=e.source1mime.indexOf("audio")?j.settings.audio_template_callback?c=j.settings.audio_template_callback(e):c+='<audio controls src="../../../../../admin/editors/tinymce/plugins/media/'+e.source1+'">'+(e.source2?'\n<source src="../../../../../admin/editors/tinymce/plugins/media/'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</audio>":c=j.settings.video_template_callback?j.settings.video_template_callback(e):'<video width="'+e.width+'" height="'+e.height+'"'+(e.poster?' poster="../../../../../admin/editors/tinymce/plugins/media/'+e.poster+'"':"")+' controls="controls">\n<source src="../../../../../admin/editors/tinymce/plugins/media/'+e.source1+'"'+(e.source1mime?' type="'+e.source1mime+'"':"")+" />\n"+(e.source2?'<source src="../../../../../admin/editors/tinymce/plugins/media/'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</video>"),c):""}function d(c){var a={};return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",start:function(i,l){a.source1||"param"!=i||(a.source1=l.map.movie),("iframe"==i||"object"==i||"embed"==i||"video"==i||"audio"==i)&&(a=tinymce.extend(l.map,a)),"source"==i&&(a.source1?a.source2||(a.source2=l.map.src):a.source1=l.map.src)}}).parse(c),a.source1=a.source1||a.src||a.data,a.source2=a.source2||"",a.poster=a.poster||"",a}function g(a){return a.getAttribute("data-mce-object")?d(j.serializer.serialize(a,{selection:!0})):{}}function q(u,o,v){function l(A,y){var B,x,w,z;for(B in y){if(w=""+y[B],A.map[B]){for(x=A.length;x--;){z=A[x],z.name==B&&(w?(A.map[B]=w,z.value=w):(delete A.map[B],A.splice(x,1)))}}else{w&&(A.push({name:B,value:w}),A.map[B]=w)}}}var c=new tinymce.html.Writer,s=0;return new tinymce.html.SaxParser({validate:!1,special:"script,noscript",comment:function(a){c.comment(a)},cdata:function(a){c.cdata(a)},text:function(i,a){c.text(i,a)},start:function(i,n,a){switch(i){case"video":case"object":case"img":case"iframe":l(n,{width:o.width,height:o.height})}if(v){switch(i){case"video":l(n,{poster:o.poster,src:""}),o.source2&&l(n,{src:""});break;case"iframe":l(n,{src:o.source1});break;case"source":if(s++,2>=s&&(l(n,{src:o["source"+s],type:o["source"+s+"mime"]}),!o["source"+s])){return}}}c.start(i,n,a)},end:function(i){if("video"==i&&v){for(var n=1;2>=n;n++){if(o["source"+n]){var a=[];a.map={},n>s&&(l(a,{src:o["source"+n],type:o["source"+n+"mime"]}),c.start("source",a,!0))}}}c.end(i)}},new tinymce.html.Schema({})).parse(u),c.getContent()}var k=[{regex:/youtu\.be\/([a-z1-9.-_]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"http://www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"http://player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'http://maps.google.com/maps/ms?msid=$2&output=embed"'}];j.on("ResolveName",function(c){var a;1==c.target.nodeType&&(a=c.target.getAttribute("data-mce-object"))&&(c.name=a)}),j.on("preInit",function(){var a=j.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(i){a[i]=new RegExp("</"+i+"[^>]*>","gi")}),j.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var c=j.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(i){c[i]={}}),j.parser.addNodeFilter("iframe,video,audio,object,embed",function(C,w){for(var y,A,e,v,x,D,z,B=C.length;B--;){for(A=C[B],e=new tinymce.html.Node("img",1),e.shortEnded=!0,D=A.attributes,y=D.length;y--;){v=D[y].name,x=D[y].value,"width"!==v&&"height"!==v&&"style"!==v&&(("data"==v||"src"==v)&&(x=j.convertURL(x,v)),e.attr("data-mce-p-"+v,x))}z=A.firstChild&&A.firstChild.value,z&&(e.attr("data-mce-html",escape(z)),e.firstChild=null),e.attr({width:A.attr("width")||"300",height:A.attr("height")||("audio"==w?"30":"150"),style:A.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":w,"class":"mce-object mce-object-"+w}),A.replace(e)}}),j.serializer.addAttributeFilter("data-mce-object",function(z,C){for(var w,y,B,u,v,x,D=z.length;D--;){for(w=z[D],y=new tinymce.html.Node(w.attr(C),1),"audio"!=w.attr(C)&&y.attr({width:w.attr("width"),height:w.attr("height")}),y.attr({style:w.attr("style")}),u=w.attributes,B=u.length;B--;){var A=u[B].name;0===A.indexOf("data-mce-p-")&&y.attr(A.substr(11),u[B].value)}v=w.attr("data-mce-html"),v&&(x=new tinymce.html.Node("#text",3),x.raw=!0,x.value=unescape(v),y.append(x)),w.replace(y)}})}),j.on("ObjectSelected",function(a){"audio"==a.target.getAttribute("data-mce-object")&&a.preventDefault()}),j.on("objectResized",function(c){var a,i=c.target;i.getAttribute("data-mce-object")&&(a=i.getAttribute("data-mce-html"),a&&(a=unescape(a),i.setAttribute("data-mce-html",escape(q(a,{width:c.width,height:c.height})))))}),j.addButton("media",{tooltip:"Insert/edit video",onclick:h,stateSelector:"img[data-mce-object=video]"}),j.addMenuItem("media",{icon:"media",text:"Insert video",onclick:h,context:"insert",prependToContext:!0})});